var mongoose = require('mongoose');
var debug = require('debug')('appreports:db');

mongoose.connection.on('connected', function () {
  debug('db connected');
});

mongoose.connection.on('error',function (err) {
  debug('db error', err);
  mongoose.connection.close();
});

mongoose.connection.on('disconnected', function () {
  debug('db disconnected');
});

mongoose.connection.on('close', function () {
  debug('db connection closed');
  connect();
});

var connect = exports.connect = function() {
  if(!process.env.MONGO_URI) {
    throw 'Must set MONGO_URI environment variable';
  }

  debug('connecting to db');
  mongoose.connect(process.env.MONGO_URI, { server: { socketOptions: { keepAlive: 1 } } });
  mongoose.set('debug', process.env.MONGO_DEBUG || false);
}
