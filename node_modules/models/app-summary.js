var mongoose = require('mongoose');
var Schema = mongoose.Schema;
var todayAsNumber = require('app/date').todayAsNumber;

var appSummarySchema = new Schema({
  storeId: String,
  date: Number,
  name: String,
  image: String,
  primaryUrl: String,
  platform: String,
  usaRatings: Number,
  usaRatingsChange: Number,
  usaAverage: Number,
  usaAverageChange: Number,
  worldRatings: Number,
  worldRatingsChange: Number,
  worldAverage: Number,
  worldAverageChange: Number,
  finalized: Boolean
}, { autoIndex: process.env.MONGO_AUTOINDEX || false });

appSummarySchema.statics.getCurrentSummary = function(done) {
  this.find({}, {date: 1}).sort({date: -1}).limit(1).exec(function(err, doc) {
    var date = todayAsNumber();
    if(doc.length === 1) {
      date = doc[0].date;
    }

    this.find({ date: date }, done);
  }.bind(this));
}

module.exports = mongoose.model('AppSummary', appSummarySchema);
